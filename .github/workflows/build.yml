name: Upload builds to release

on:
  workflow_dispatch: 
  release: 
    types: [released, prereleased]
  # push:
    # tags:
      # - '*'

jobs:
  build-appimage:
    name: Build and upload AppImage
    runs-on: ubuntu-18.04

    steps:
      - uses: actions/checkout@v2
      - uses: iffy/install-nim@v4.1.1
      - name: Install x11 dev libraries
        run: |
          sudo apt-get install libxcursor-dev libxrandr-dev libxinerama-dev libxi-dev libgl-dev
      - name: Install appimagetool
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O /usr/local/bin/appimagetool
          sudo chmod +x /usr/local/bin/appimagetool
      - name: Build and run AppImage
        run: |
          nimble install -d -y
          nake build
      - name: Upload release binaries
        uses: alexellis/upload-assets@0.2.2
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          asset_paths: '["AppDir/*.AppImage"]'
  build-exe:
    name: Build and upload .exe
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v2
      - uses: iffy/install-nim@v4.1.1
      - name: Build and run .exe
        run: |
          nimble install -d -y
          # echo "$HOME/.nimble/bin" >> $GITHUB_PATH
          nimble buildapp
      - name: Upload release binaries
        uses: alexellis/upload-assets@0.2.2
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          asset_paths: '["*.exe"]'
